@echo off
echo Скрипт для создания самоподписанного сертификата для сервера WEC

:: ** Настройки **
SET CertificateName=WECServerCert
SET KeyLength=2048
SET ValidityYears=1

:: ** Автоматическое получение FQDN **
FOR /F "tokens=*" %%a IN ('hostname') DO SET ServerFQDN=%%a
IF "%ServerFQDN%"=="%COMPUTERNAME%" (
    echo Не удалось автоматически определить FQDN. Пожалуйста, укажите FQDN вручную.
    SET /p ServerFQDN="Введите FQDN сервера (например, wec.example.com): "
    IF "%ServerFQDN%"=="" (
        echo FQDN не указан. Скрипт завершен.
        goto :error
    )
)
echo FQDN сервера определен как: %ServerFQDN%

:: ** Путь для сохранения файлов **
SET CertRequestFile=%CertificateName%.req
SET CertInfFile=%CertificateName%.inf
SET CertFile=%CertificateName%.cer

echo Создание INF файла запроса сертификата...
echo [Version] > %CertInfFile%
echo Signature="$Windows NT$" >> %CertInfFile%
echo [NewRequest] >> %CertInfFile%
echo Subject="CN=%ServerFQDN%" >> %CertInfFile%
echo KeySpec=1 >> %CertInfFile%
echo KeyLength=%KeyLength% >> %CertInfFile%
echo Exportable=TRUE >> %CertInfFile%
echo MachineKeySet=TRUE >> %CertInfFile%
echo SMIME=FALSE >> %CertInfFile%
echo PrivateKeyArchive=FALSE >> %CertInfFile%
echo UserProtected=FALSE >> %CertInfFile%
echo UseExistingKeySet=FALSE >> %CertInfFile%
echo ProviderName="Microsoft RSA SChannel Cryptographic Provider" >> %CertInfFile%
echo ProviderType=12 >> %CertInfFile%
echo RequestType=PKCS10 >> %CertInfFile%
echo HashAlgorithm=sha256 >> %CertInfFile%
echo [Extensions] >> %CertInfFile%
echo 2.5.29.17 = "{text}" >> %CertInfFile%
echo _continue_ = "dns=%ServerFQDN%&" >> %CertInfFile%
echo 2.5.29.37 = "{text}" >> %CertInfFile%
echo _continue_ = "1.3.6.1.5.5.7.3.1" >> %CertInfFile%

echo.
echo Генерация запроса сертификата...
certreq -new %CertInfFile% %CertRequestFile%
if NOT %ERRORLEVEL% == 0 (
    echo.
    echo ** Ошибка при генерации запроса сертификата. Проверьте ошибки выше. **
    goto :error
)

echo.
echo Самоподписание сертификата...
certreq -sign %CertRequestFile% %CertFile%
if NOT %ERRORLEVEL% == 0 (
    echo.
    echo ** Ошибка при самоподписании сертификата. Проверьте ошибки выше. **
    goto :error
)

echo.
echo ** Сертификат успешно создан: %CertFile% **
echo.
echo ** Инструкции: **
echo 1. Импортируйте файл '%CertFile%' в хранилище "Trusted Root Certification Authorities" на сервере WEC.
echo 2. Экспортируйте файл '%CertFile%' и импортируйте его в хранилище "Trusted Root Certification Authorities" на недоменных компьютерах.
echo.

goto :end

:error
pause
:end
